# 第三代控制箱

### 32.768晶振不起振的解决方案

* MCU启动时，不启用LSE
* 程序运行起来之后，切换成LSE
* 如果LSE切换失败，切换成HSE

### 编译不同控制箱的目标文件

##### 修改 `bsp/board_config.h`文件

* Y520版本
  ```c
  #define BOARD_TYPE BOARD_TYPE_Y520
  ```

##### `BOARD_TYPE` 支持

* `BOARD_TYPE_Y520`

### 时钟

* 每运行24小时，向服务器请求更新一次时间（已经链接到服务器）
* 每分钟检查年是否小于 `2020`年，小于则向服务器请求更新一次时间（已经链接到服务器）
* 每分钟检查 `LSE`是否会正常工作，如果没有正常工作，切换为 `HSE`， 如果当前已经连接到服务器则请求更新时间，如果未连接到服务器则会等连接到服务器后，再更新时间。
* 切换为 `HSE`后， 关机再时，开机时间为 `2000年1月1日0时0分0秒`, 。

### 水质数据平滑值

* 使用最近 `10`条水质数据做平均值
* 如果连续3个水质数据读取为故障，则报故障
* 当计算平滑值的个数少于 `10`个时，`智能`和 `定时中的门限`不起作用

### 传感器

* 目前只支持 `DO-Y100` `DO-Y101` `DO-Y102` `DO-Y103` `DO-Y121` `DO-Y170` `PH-201` `PH202` `PH-230` `PH280` 10种传感器，或兼容协议。

### 继电器

* 开机后，过大概 `12`秒，开始运行继电器控制逻辑，防止MCU运行到控制继电器时，时钟还未启动，读取的时间为 `2000-01-01 00:00:00`。 定时任务时间为 `0时0分`会出现开 `5`秒后关。
* 继电器状态数据中，`智能`,`定时`,`远程手动` `本地手动` 的状态，当控制为 `开`或 `关`时，相应的通道控制位为 `1`，不受控制时为 `0`

### 协议

* 所有的 `probe_id`只支持 `1`,否则返回 `D1`错误
* 所有的 `relay_id`只支持 `1`,否则返回 `D1`错误
* 硬件版本默认为 `1.0.0`

##### 设备ID

* 设备ID的范围为： `1~9999999`
* 当设置设备ID时，当前设置的指令还是以旧ID返回状态
  例：设备的当前ID为1，修改为3；这条设置指令返回的命令状态的设备ID还是1，
  下一条指令使用新ID通信

##### 软件版本

* 配置 `固件版本`无效，应该使用不同的固件,程序固件已经定义了固件版本
* 配置 `PN`无效，应该使用不同的固件
* 配置 `SN`中的 `代码`、`ID`无效， 固件中已经把SN中的前缀固定，ID由产品ID决定
* 当配置设备时，这条指令中只有 `硬件版本`、`年周`、`串号有效`

##### 读取变送器配置

* `读` OK
* `写` OK，目前只支持 `pH`, `DO`的写入，如果配置了其他的传感器会被忽略
* `删除` OK

##### 控制门限

* `读` OK
* `写` OK
* `删除` OK
* `写`指令里的 `备用通道`无效
* `继电器ID` 无效，固定值为 `1`

##### 告警门限

* `读` OK
* `写` OK
* `删除` OK，删除所有告警门限
* `窗口值`可以读写，但程序上没有使用

##### 固定时间任务

* `读` OK
* `写` OK
* `删除` OK，删除所有告警门限
* `窗口值`可以读写，但程序上没有使用

#### 盐度值

* `读` OK
* `写` OK
* 未设置盐度时，默认为 `0`
* 盐度值保存在控制箱上，当控制箱上电时， 写到传感器。

#### 传感器校准

* 如果传感器类型不对，校正有可能会报 `校正错误`

##### 设置时间

* 设置时间里的 `周`无效，`周`设备会计算
* 设备会验算 `日期`，`时间`的有效性
* -- 服务器添加 `读`指令

##### 手动控制继电器

* 控制 OK
* `写`手动控制时，会打开该通道的使能

##### 手动控制继电器使能

* `读` OK, 如果通道上，从来没有手动控制过，使能位为 0
* `写` OK

##### 设备系统设置

* `读`指令返回固定值
* `写`指令无效，直接返回失败

#### 智能控制使能

* `读`指令无效，直接返回失败
* `写`指令无效，直接返回失败

##### 设备使能

* `读`指令返回固定值，`0x11 0x01 0x01`
* `写`指令无效，直接返回失败

##### 系统支持容量

* `读`指令返回固定值
* `写`指令无效，直接返回失败
* 设备服务器的 `读`指令解析有问题！！！

#### 水质数据

* 手动请求的水质数据为 `实时值`
* 自动上传的水质数据为 `平滑值`

#### 继电器数据

* 当本地手动开启继电器后，远程手动、定时、智能都无法关闭继电器。
* `1`秒内，如果多次操作继电器，只对最后一次操作做反应
* 需要 `动作的继电器`之间，有 `0.3`秒的间隔时间

#### 恢复出厂设置

* OK

#### 系统实际使用容量

* `读`指令返回固定值
* `写`指令无效，直接返回失败

#### 继电器终端配置

* `读`指令返回固定值
* `写`、`删除`指令无效，直接返回失败

#### 读继电器固定时间任务控制使能

* `读` OK, 如果任务ID上， 没有任务，使能位为 0
* `写` OK

##### 重启

* OK
* 支持DTU或气吹断电的型号。 断电时长为3s. 设备3s后才会重启。

##### GPRS信号质量

* OK

##### 心跳包

* 未连接服务器，不发送心跳包
* 每2分钟上传一次心跳包

#### 向服务器请求时间

* 当时钟超过1~2分钟不走了，且已经连接到服务器，设备会向服务器请求时间

### 气吹装置

#### 处理流程

1. 上电会发送泄气指令
2. 等待L6装置准备好
3. 读传感器数据

#### 故障处理逻辑

1. 如果通信未返回或返回设备状态为故障连续超过10次，则重启L6
2. 如果重启超过3次设备任然没有好则强制读取传感器数据，不处理L6的逻辑
3. 强制读取的数据当成正常的数据

#### 设置L6

1. 设置L6失败。返回 `设置失败`的状态
2. 如果某项不设置，则表示设置成默认值。默认值参见L6的文档

#### 注意事项

1. 未读到传感器数据之前，不执行任何与传感器相关的控制逻辑
2. 未读到传感器数据之前，不上传任何水质数据
3. 在最理想的情况下，设备上电后2分钟后才可以读取数据(L6的限制)
4. 上电后任何与传感器相关的控制至少会等2分钟后才会运行
5. 气吹版本的数据平滑个数为 `15`个
6. __手动刷新传感器数据为最后一次读取的数据，`非实时数据`。__

### EEPROM格式化程序

* 项目： `Y-520_main_control_formatter`
* 主要针对没有屏幕和按键的设备例如：`Y-520`

#### 编译

* 气吹版本在编译此程序时， #define BOARD_TYPE BOARD_TYPE_Y520

#### EEPROM格式化成功的状态

* 格式化成功，气吹24V会每隔 `1秒` 开关一下，状态灯会每隔 `1秒` 亮灭一下。
* 格式化失败，气吹24V会每个 `0.2/1.8秒` 开关一下，状态灯会每隔 `0.2/1.8秒` 亮灭一下。

#### 变频增氧机

* 对于故障和缺相判断延迟50s。
* 检查输出状态时，对前一次的状态进行判断

#### 气吹系统校准刷数据

* 在气吹系统中校准后到下个气吹周期期间，可以刷新实时数据

#### DO传感器在气吹系统中诊断

* 每天0:00:00——0:40:00对于溶氧进行空气中的数据进行取值，1次/10分钟，当饱和度大于120或小于85的次数超过3次，则上报预警（传感器需要维护——清洗或是校准）
* 每次上传传感器数据时进行取值，连续取值144个后进行判断其饱和度值的差值，最大饱和度和最小饱和度差值小于10，则上报预警（传感器在空气中）

#### 在线升级

* 在服务器端通过 GPRS 模块即可给控制箱程序进行升级;

#### 温湿度和电压电流检测

* 给 Y-520 开放了温湿度以及电压检测功能宏定义；

#### 传感器扫描

1. 设备上电/重启后,读取EEPROM中的传感器配置,30s后第一次扫描传感器；
2. 任何时刻,当执行了来自服务器的“配置传感器指令”后,扫描传感器；
3. 前一次扫描传感器后,间隔10min,再次扫描传感器；

#### 上报传感器信息

* 首先必须保证已经连上服务器,然后再按下列情况进行处理；

1. 当执行了来自服务器的“配置传感器指令”后,扫描传感器,主动上报一次传感器识别结果；
2. 在每天的特定时间段(大约在 0:01:00 左右)上报一次传感器识别结果；
3. 当周期扫描传感器时发现传感器型号发生变化,主动上报一次传感器识别结果；
4. 设备上电/重启,若扫描传感器时没有接入传感器(或传感器未正常工作)，则连上服务器5min后,上报一次传感器识别结果；

* 若在上电之后、连上服务器之前,传感器扫描发现传感器发生变化,则等到连上服务器之后再上报；

#### 与检测控制板通讯

* 通过 UART4 与检测控制板通讯，发送控制、配置指令给检测控制板，并接收来自检测控制板上报的继电器通道状态数据、版本信息数据。
* 当超过60s未接收到检测控制板上传数据时，认为检测控制板失联，上报一帧“设备告警”到服务器，并且LED状态灯按照 `亮0.1s，灭0.2s` 循环闪烁。
* 当与检测控制板失联后，不再下发操作指令到检测控制板。
* 再次收到检测控制板数据后，则认为重新与检测控制板建立连接。
* 若在"失联"之前，连续发送4帧操作命令都无应答，则不再下发操作指令。

#### 重启GPRS模块电源

* 上电等待5s启动与GPRS模块的通讯任务。60s内检测从USART6接收到GPRS模块的有效数据帧，

1. 若未接收到任何有效数据，则关闭GPRS模块电源，并在5s后重新打开GPRS模块电源，再次检测60s内是否有有效数据；
2. 若重启3次后仍然接收不到任何有效数据，则关闭GPRS模块电源。
